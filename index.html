<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>FXJ map Christmas lights</title>
    <meta name="keywords" content="christmas lights, xmas lights, canberra, act, houses, addresses, dataviz, map">
    <meta name="author" content="Markus Mannheim">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="style.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-tile.v0.0.min.js"></script>
  </head>
  <body>
    <script>
      // initial chart variables
      var titleText = "Canberra's Christmas lights",
        sourceText = "OpenStreetMap contributors, CARTO",
        sourceLink = "https://carto.com/";
      // div for map
      var container = d3.select("body").append("div")
        .attr("id", "container");
      // map dimensions (in pixels)
      var mapWidth = parseInt(container.style("width")),
        mapHeight = mapWidth;
      if (mapHeight > 500) mapHeight = 500;
      // enter title
      container.append("div")
        .attr("id", "title")
        .text(titleText);
      // enter description
      container.append("div")
        .attr("id", "description")
        .html("add more houses to the map by <strong><a href='https://form.jotform.com/73228019318960' target='blank'>clicking here</a></strong>");
      // svg container
      var map = container.append("svg")
        .attr("id", "map")
        .attr("width", mapWidth)
        .attr("height", mapHeight);
        containerHeight = parseInt(container.style("height"));
      // copyright
      var copyright = container.append("div")
        .attr("id", "copyright")
        .html("&copy; 2017 (details)")
        .on("mouseover", copyrightOn)
        .on("mouseout", copyrightOff),
        copyrightWidth = parseInt(copyright.style("width")),
        copyrightDetail = container.append("div")
         .attr("id", "copyrightDetail")
         .style("top", containerHeight - 65 + "px")
         .html("Graphic coding: &copy; Markus Mannheim<br>" +
               "D3 library: &copy; Mike Bostock (see d3js.org)<br>" +
               "Licences: BSD (coding), ODbL and OSMF (tiles)");
      // enter source
      source = container.append("div")
        .attr("id", "source")
        .style("padding-left", copyrightWidth + "px");
      source.append("a")
        .attr("href", sourceLink)
        .attr("target", "blank")
        .text("Map tiles: " + sourceText);
      // prepare the data map
      var tau = 2 * Math.PI;
      // set up the projection to fit the world in a 1Ã—1 square centreed at the origin
      var projection = d3.geoMercator()
        .scale(1 / tau)
        .translate([0, 0]);
      var tile = d3.tile()
        .size([mapWidth, mapHeight]);
      var star = d3.symbol()
        .type(d3.symbolStar)
        .size(250);
      var zoom = d3.zoom()
        .scaleExtent([1 << 19, 1 << 24])
        .translateExtent([projection([148.8, -35.1]), projection([149.4, -35.5])])
        .on("zoom", zoomed);
      var raster = map.append("g")
        .attr("id", "raster");
      var addresses = map.append("g")
        .attr("id", "addresses")
      // set the starting projection centre
      var centre = projection([149.1242, -35.3082]);
      // read in the lights data and draw map
      d3.csv("markusData.csv", function(error, lightsData) {
        if (error) throw error;
        // format data
        lightsData.forEach(function(d) {
          return {
            street: d.street,
            suburb: d.suburb,
            photo: d.photoUrl,
            description: d.description,
            latitude: +d.longitude,
            longitude: +d.latitude
          };
        });
        // draw the light locations
        addresses.selectAll("path")
          .data(lightsData)
          .enter().append("path")
            .attr("class", "star")
            .attr("d", star)
            .attr("transform", function(d) { movestar(d); });
        // draw the tiles
        map.call(zoom)
          .call(zoom.transform, d3.zoomIdentity
            .translate(mapWidth / 2, mapHeight / 2)
            .scale(1 << 19)
            .translate(-centre[0], -centre[1]));
      });
      function moveStar(d) {
        return "translate(" + projection([d.longitude, d.latitude])[0] + ", " + projection([d.longitude, d.latitude])[1] + ")";
      }
      function zoomed() {
        var change = d3.event.transform;
        var tiles = tile
          .scale(change.k)
          .translate([change.x, change.y])
          ();
        addresses.selectAll("path")
          .attr("transform", "translate(" + [change.x, change.y] + ")");
        var tileImage = raster
          .attr("transform", stringify(tiles.scale, tiles.translate))
          .selectAll("image")
          .data(tiles, function(d) { return d; });
        tileImage.exit().remove();
        tileImage.enter().append("image")
          .attr("xlink:href", function(d) { return "https://cartodb-basemaps-" + "abc"[d[1] % 3] + ".global.ssl.fastly.net/light_all/" + d[2] + "/" + d[0] + "/" + d[1] + ".png"; })
          .attr("x", function(d) { return d[0] * 256; })
          .attr("y", function(d) { return d[1] * 256; })
          .attr("width", 256)
          .attr("height", 256);
      }
      function stringify(scale, translate) {
        var k = scale / 256, r= scale %1 ? Number : Math.round;
        return "translate(" + r(translate[0] * scale) + "," + r(translate[1] * scale) + ") scale(" + k + ")";
      }
      function copyrightOn() {
        copyrightDetail.transition()
        .delay(250)
        .style("opacity", .9);
      }
      function copyrightOff() {
        copyrightDetail.transition()
        .delay(250)
        .style("opacity", 0);
      }
    </script>
  </body>
</html>
