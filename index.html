<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Mapping 06 Australia with tiles</title>
    <meta name="keywords" content="dataviz, geodata, d3, zoom, pan">
    <meta name="author" content="Markus Mannheim">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="style.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-tile.v0.0.min.js"></script>
  </head>
  <body>
    <script>
      // initial variables
      var titleText = "Australia with tiles",
          descriptionText = "Experimental mapping with d3.tile",
          sourceText = "Map tiles: Carto DB & OpenStreetMap",
          sourceLink = "https://www.openstreetmap.org",

          pi = Math.PI,
          tau = 2 * pi;

      // map div
      var container = d3.select("body").append("div")
                   .attr("id", "container");

      // define map dimensions (pixels)
      var mapWidth = parseInt(container.style("width")),
          mapHeight = mapWidth;
      if (mapHeight > 500) mapHeight = 500;

      // enter title
      container.append("div")
               .attr("id", "title")
               .text(titleText);

      // enter description if it exists
      if (descriptionText != "") {
        container.append("div")
                 .attr("id", "description")
                 .text(descriptionText);
      };

      // svg container
      var map = container.append("svg")
             .attr("id", "map")
             .attr("width", mapWidth)
             .attr("height", mapHeight);

      var containerHeight = parseInt(container.style("height"));

      // copyright
      var copyright = container.append("div")
                   .attr("id", "copyright")
                   .html("&copy; 2017 (details)")
                   .on("mouseover", copyrightOn)
                   .on("mouseout", copyrightOff);
      var copyrightWidth = parseInt(copyright.style("width"));
      var copyrightDetail = container.append("div")
                         .attr("id", "copyrightDetail")
                         .style("top", containerHeight - 55 + "px")
                         .html("Graphic coding: &copy; Markus Mannheim<br>" +
                               "D3 library: &copy; Mike Bostock (see d3js.org)<br>" +
                               "Coding released under BSD licence.");

      // enter source if it exists
      if (sourceText != "") {
        source = container.append("div")
              .attr("id", "source")
              .style("padding-left", copyrightWidth + "px");
        if (sourceLink != "") {
          source.append("a")
                .attr("href", sourceLink)
                .attr("target", "blank")
                .text(sourceText);
        } else {
          source.text("Source: " + sourceText);
        };
      }

      // Initialize the projection to fit the world in a 1Ã—1 square centered at the origin.
      var projection = d3.geoMercator()
                    .scale(1 / tau)
                    .translate([0, 0]);

      var tile = d3.tile()
              .size([mapWidth, mapHeight]);

      var zoom = d3.zoom()
              .scaleExtent([1 << 12, 1 << 22])
              .translateExtent([projection([100, 0]), projection([165, -50])])
              .on("zoom", zoomed);

      var mapGroup = map.append("g");

      // Compute the projected initial center.
      var centre = projection([133.42, -27]);

      // Apply a zoom transform equivalent to projection.{scale,translate,center}.
      map.call(zoom)
         .call(zoom.transform, d3.zoomIdentity
           .translate(mapWidth / 2, mapHeight / 2)
           .scale(1 << 12)
           .translate(-centre[0], -centre[1]));

      function zoomed() {
        var change = d3.event.transform;

        var tiles = tile
                 .scale(change.k)
                 .translate([change.x, change.y])
                 ();

        var image = mapGroup
                 .attr("transform", stringify(tiles.scale, tiles.translate))
                 .selectAll("image")
                 .data(tiles, function(d) { return d; });

        image.exit().remove();

        image.enter().append("image")
             .attr("xlink:href", function(d) { return "https://cartodb-basemaps-" + "abcd"[d[1] % 4] + ".global.ssl.fastly.net/light_all/" + d[2] + "/" + d[0] + "/" + d[1] + ".png"; })
             .attr("x", function(d) { return d[0] * 256; })
             .attr("y", function(d) { return d[1] * 256; })
             .attr("width", 256)
             .attr("height", 256);
      }

      function stringify(scale, translate) {
        var k = scale / 256, r = scale % 1 ? Number : Math.round;
        return "translate(" + r(translate[0] * scale) + "," + r(translate[1] * scale) + ") scale(" + k + ")";
      }

      function copyrightOn() {
        copyrightDetail.transition()
        .delay(250)
        .style("opacity", .9);
      }

      function copyrightOff() {
        copyrightDetail.transition()
        .delay(250)
        .style("opacity", 0);
      }
    </script>
  </body>
</html>
